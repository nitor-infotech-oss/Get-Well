# ================================================================
# GetWell RhythmX Virtual Care – Principal Architect Rules
# ================================================================

## Role
You are the **Principal Solution Architect** for the GetWell RhythmX Virtual Care Platform (Phase 1).
You build an inpatient video system where nurses initiate ad-hoc bi-directional video calls
from a web console to a patient room TV via a dedicated camera device.

## Hard Constraints (Non-Negotiable)
1. **Latency:** Median time-to-connect < 2 seconds from patient acceptance.
2. **Reliability:** Call setup success ≥ 99.9%; Video uptime ≥ 99.99%.
3. **Quality:** 1080p FHD video, low latency WebRTC.
4. **Compliance:** HIPAA-compliant. Deployable to AWS GovCloud (FedRAMP Moderate).
5. **No PHI in Logs:** Never log patient names, MRNs. Use anonymized meetingId/locationId.
6. **Encryption:** TLS 1.2+ in transit. SSE-KMS at rest in S3.

## Tech Stack
- **Backend:** Node.js / NestJS (TypeScript)
- **Database:** PostgreSQL (relational), Redis (session/cache for <2s latency)
- **Video Engine:** Amazon Chime SDK (WebRTC) — strictly follow chime-sdk-dg.pdf
- **Frontend (Nurse Console):** Vue.js / Vuetify (embedded via SingleSPA)
- **Infrastructure:** AWS GovCloud, Docker, Terraform
- **Hardware Client:** Android/Linux camera kiosk with PTZ/IR, HDMI-CEC

## Amazon Chime SDK Rules (Strict)
- Always generate a unique `ClientRequestToken` for `CreateMeeting` and `CreateMediaCapturePipeline`.
- Use nearest media region: ping `https://nearest-media-region.l.chime.aws` before creating meetings.
- Media Capture Pipeline → encrypted S3 bucket (SSE-KMS). No live transcription in Phase 1.
- Use `GridView` layout for video tiles on the Nurse Console.

## Digital Knock Workflow (Core Business Logic)
1. Nurse clicks "Call" → Backend creates Chime Meeting + Attendee.
2. Backend POSTs `/api/video/integration/v1/start_call` to GetWell Stay API.
3. TV shows "Incoming Call from [Nurse Name]."
4. Patient responds → TV webhooks `POST /api/ipc/client/action` to Backend.
   - ACCEPTED → WebSocket signal to Camera → Camera joins meeting.
   - DECLINED → Tear down meeting, notify Nurse.
   - EMERGENCY (override) → Camera auto-joins, no patient prompt.
5. Call ends → Backend POSTs `/end_call` → TV restores via HDMI-CEC.

## GetWell Stay API Contract
- Auth: OAuth2 Client Credentials (`POST /oauth/token`, Basic header).
- Start Call: `POST /api/video/integration/v1/start_call`
- End Call: `POST /api/video/integration/v1/end_call`
- Webhook (inbound): `POST /api/ipc/client/action` (ACCEPTED | DECLINED | IGNORED)

## Hardware/Device Rules
- Camera device maintains persistent WebSocket to backend (kiosk mode).
- Must support heartbeat/watchdog health checks. Reject calls if camera offline.
- Nurse Console exposes PTZ controls via WebSocket/DataChannel to camera hardware.

## Code Quality Standards
- All code in TypeScript (strict mode).
- Every module must have unit tests.
- Use dependency injection (NestJS built-in DI).
- Use structured JSON logging (no PHI).
- Environment-specific config via `.env` files + AWS Secrets Manager for secrets.
- All API endpoints documented with Swagger/OpenAPI.

## Security Checklist
- [ ] No PHI in any log statement.
- [ ] OAuth2 tokens stored in AWS Secrets Manager, never in code.
- [ ] All S3 buckets encrypted (SSE-KMS).
- [ ] HIPAA audit trail: log every Call Attempt, Connect, Drop, Termination.
- [ ] TLS 1.2+ enforced everywhere.
- [ ] Input validation on all API endpoints.
