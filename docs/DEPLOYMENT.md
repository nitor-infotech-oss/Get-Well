# GetWell RhythmX — Deployment Guide

This document covers deploying the GetWell RhythmX application to AWS: infrastructure provisioning (Terraform), Docker Compose production stack, and GitHub Actions CI/CD.

---

## Table of Contents

1. [Architecture Overview](#1-architecture-overview)
2. [Prerequisites](#2-prerequisites)
3. [Infrastructure (Terraform)](#3-infrastructure-terraform)
4. [Manual Deploy (First Time)](#4-manual-deploy-first-time)
5. [CI/CD (GitHub Actions)](#5-cicd-github-actions)
6. [GitHub Secrets](#6-github-secrets)
7. [Production URLs](#7-production-urls)
8. [Troubleshooting Deployment](#8-troubleshooting-deployment)

---

## 1. Architecture Overview

```
                    ┌─────────────────────────────────────────┐
                    │              EC2 Instance                 │
                    │  ┌─────────────────────────────────────┐ │
                    │  │  Docker Compose (docker-compose.prod)│ │
                    │  │  ┌──────┐ ┌──────┐ ┌─────┐ ┌──────┐ │ │
Internet            │  │  │ Nginx│ │NestJS│ │ PG  │ │Redis │ │ │
   │                │  │  │ :80  │ │:3000 │ │:5432│ │:6379 │ │ │
   │  HTTPS         │  │  │ :443 │ │      │ │     │ │      │ │ │
   └────────────────┼──┼──┼──────┼─┼──────┼─┼─────┼─┼──────┼─┼─┘
                    │  │  └──┬───┘ └──┬───┘ └─────┘ └──────┘ │
                    │  │     │        │                       │
                    │  │     │  /api  │  proxy to backend     │
                    │  │     │  /socket.io  proxy (WebSocket) │
                    │  │     │  /     │  SPA static files     │
                    │  └─────┴────────┴───────────────────────┘
                    └─────────────────────────────────────────┘
```

- **Nginx:** Serves Vue SPA, reverse-proxies `/api/` and `/socket.io/` to the backend. HTTPS (self-signed cert) + HTTP→HTTPS redirect.
- **Backend:** NestJS, connects to Postgres and Redis in the same Docker network.
- **Database:** PostgreSQL 16 (Docker volume).
- **Cache:** Redis 7 (Docker volume).

---

## 2. Prerequisites

| Tool | Purpose |
|------|---------|
| **AWS CLI** | Configure credentials, run Terraform |
| **Terraform** | >= 1.5.0 |
| **Git** | Clone and push to GitHub |
| **SSH** | Connect to EC2 for manual deploy |

```bash
# Verify
aws sts get-caller-identity
terraform version
```

---

## 3. Infrastructure (Terraform)

The `infrastructure/aws-poc/` directory provisions a minimal POC stack in **us-east-1**:

| Resource | Purpose |
|----------|---------|
| VPC, Subnet | Isolated network |
| Security Group | SSH (22), HTTP (80), HTTPS (443) |
| EC2 (t3.small) | Single instance for the full stack |
| Elastic IP | Stable public IP |
| IAM Role | Chime SDK permissions for EC2 |
| SSH Key | `deploy-key.pem` ( Terraform-generated) |

### Steps

```bash
cd infrastructure/aws-poc

# Initialize
terraform init

# Plan (review changes)
terraform plan -out=tfplan

# Apply
terraform apply tfplan
```

After apply, Terraform outputs:

- `app_public_ip` — Public IP of the EC2 instance
- `app_url` — https://&lt;ip&gt;
- `patient_url` — https://&lt;ip&gt;/patient/room-101
- `ssh_command` — SSH command to connect
- `ssh_private_key_path` — Path to deploy-key.pem

**Important:** The `deploy-key.pem` file is generated by Terraform. Keep it secure; you need it for SSH and GitHub Actions.

### User Data (EC2 Bootstrap)

The EC2 instance runs a user-data script that installs:

- Docker
- Docker Compose plugin
- Git

No manual Docker installation is required.

---

## 4. Manual Deploy (First Time)

Before CI/CD is configured, you can deploy manually via SSH.

### 4.1 Connect to EC2

```bash
# From infrastructure/aws-poc (or use full path to key)
ssh -i deploy-key.pem ec2-user@<APP_PUBLIC_IP>
```

### 4.2 Clone and Configure

```bash
# Clone (use your repo URL)
git clone https://github.com/YOUR_ORG/getwell-rhythmx.git
cd getwell-rhythmx

# Create .env.prod with production values
cat > .env.prod << 'EOF'
DB_USERNAME=getwell
DB_PASSWORD=<secure-password>
DB_NAME=getwell_rhythmx
JWT_SECRET=<secure-jwt-secret>
AWS_ACCESS_KEY_ID=<your-aws-key>
AWS_SECRET_ACCESS_KEY=<your-aws-secret>
CHIME_RECORDING_BUCKET=
CHIME_KMS_KEY_ARN=
EOF
```

### 4.3 Build and Run

```bash
docker compose -f docker-compose.prod.yml --env-file .env.prod build --no-cache
docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

# Wait for health
sleep 15
docker compose -f docker-compose.prod.yml ps

# Verify
curl -k https://localhost/api/health
```

### 4.4 HTTPS Note

The frontend container uses a **self-signed SSL certificate**. Browsers will show "Not Secure" — click **Advanced** → **Proceed** for the POC. For production with a domain, use Let's Encrypt or a proper certificate.

---

## 5. CI/CD (GitHub Actions)

The workflow `.github/workflows/deploy.yml`:

1. **Test job:** Lint, build backend and frontend
2. **Deploy job:** (runs only on `main`) SSH into EC2, pull latest code, write `.env.prod`, build and restart containers

### Trigger

- **Push to `main`** — automatic deploy
- **Manual** — Workflow → Deploy to AWS → Run workflow

### Deploy Steps (what the workflow does)

1. Checkout repository
2. SSH to `EC2_HOST` as `ec2-user`
3. Clone or `git pull` into `/home/ec2-user/getwell-rhythmx`
4. Write `.env.prod` from GitHub Secrets
5. `docker compose -f docker-compose.prod.yml --env-file .env.prod build --no-cache`
6. `docker compose -f docker-compose.prod.yml --env-file .env.prod up -d`
7. Health check: `curl http://localhost/api/health`

---

## 6. GitHub Secrets

Configure these in **GitHub → Repository → Settings → Secrets and variables → Actions**:

| Secret | Description | Example |
|--------|-------------|---------|
| `EC2_HOST` | Public IP of the EC2 instance | `44.223.226.17` |
| `EC2_SSH_KEY` | Full contents of `deploy-key.pem` | `-----BEGIN RSA PRIVATE KEY-----...` |
| `GH_TOKEN` | GitHub Personal Access Token (repo scope) | For clone if private repo |
| `DB_USERNAME` | PostgreSQL username | `getwell` |
| `DB_PASSWORD` | PostgreSQL password | `<secure-password>` |
| `JWT_SECRET` | JWT signing secret | `<secure-random-string>` |
| `AWS_ACCESS_KEY_ID` | AWS access key (Chime SDK) | `AKIA...` |
| `AWS_SECRET_ACCESS_KEY` | AWS secret key | `...` |
| `CHIME_RECORDING_BUCKET` | (Optional) S3 bucket ARN for recordings | `arn:aws:s3:::bucket-name` |
| `CHIME_KMS_KEY_ARN` | (Optional) KMS key for S3 encryption | `arn:aws:kms:...` |

### Creating EC2_SSH_KEY

```bash
# On your machine, from infrastructure/aws-poc
cat deploy-key.pem | pbcopy   # macOS: copy to clipboard
# Then paste into GitHub Secret (EC2_SSH_KEY)
```

---

## 7. Production URLs

After deployment:

| Page | URL |
|------|-----|
| Nurse Console | `https://<EC2_IP>/` or `https://<EC2_IP>/login` |
| Patient Room | `https://<EC2_IP>/patient/room-101` |
| API Health | `https://<EC2_IP>/api/health` |
| Swagger (if exposed) | `https://<EC2_IP>/api/docs` |

**Login:** `nurse1@rhythmx.dev` / `Test1234!` (dev seed runs in POC mode)

---

## 8. Troubleshooting Deployment

### Containers not starting

```bash
ssh -i deploy-key.pem ec2-user@<EC2_IP>
cd getwell-rhythmx
docker compose -f docker-compose.prod.yml --env-file .env.prod logs
```

### Backend 500 on login

- Ensure `.env.prod` has correct `DB_PASSWORD`, `DB_USERNAME`, `DB_NAME`
- In POC, `NODE_ENV=development` is used so TypeORM sync creates tables and the dev seed runs. If you switch to `production`, you need migrations and a pre-seeded user.

### Patient not receiving calls

- Frontend is built with `VITE_WS_URL` empty, so Socket.IO connects via same origin. Ensure Nginx correctly proxies `/socket.io/` to the backend.
- Check browser console for `[WS] Connected to backend`.

### GitHub Actions deploy fails

- Verify `EC2_SSH_KEY` is the **entire** PEM file including `-----BEGIN` and `-----END`
- Verify `EC2_HOST` is the EC2 public IP (not a hostname)
- Ensure EC2 Security Group allows SSH (22) from GitHub Actions IPs (or 0.0.0.0/0 for POC)

### Re-deploy after code changes

Push to `main` — the workflow deploys automatically. Or run the workflow manually from the Actions tab.
